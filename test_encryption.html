<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl-fast.min.js"></script>
</head>
<body>
    <h1>–¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    <div id="test-results"></div>

    <script>
        const resultsDiv = document.getElementById('test-results');

        function log(message) {
            resultsDiv.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        // –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
        function testKeyGeneration() {
            log('üîë –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π...');
            const keyPair = nacl.box.keyPair();
            const publicKey = nacl.util.encodeBase64(keyPair.publicKey);
            const privateKey = nacl.util.encodeBase64(keyPair.secretKey);

            log('‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á: ' + publicKey.substring(0, 20) + '...');
            log('‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: ' + privateKey.substring(0, 20) + '...');

            return { keyPair, publicKey, privateKey };
        }

        // –¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
        function testEncryptionDecryption() {
            log('üîê –¢–µ—Å—Ç–∏—Ä—É–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É...');

            const alice = nacl.box.keyPair();
            const bob = nacl.box.keyPair();

            const message = '–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! üîê';
            log('üìù –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + message);

            // –ê–ª–∏—Å–∞ —à–∏—Ñ—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ë–æ–±–∞
            const ephemeralKeyPair = nacl.box.keyPair();
            const nonce = nacl.randomBytes(24);

            const encrypted = nacl.box(
                nacl.util.decodeUTF8(message),
                nonce,
                bob.publicKey,
                ephemeralKeyPair.secretKey
            );

            log('üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ' + nacl.util.encodeBase64(encrypted).substring(0, 30) + '...');

            // –ë–æ–± —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
            const decrypted = nacl.box.open(encrypted, nonce, ephemeralKeyPair.publicKey, bob.secretKey);

            if (decrypted) {
                const decryptedMessage = nacl.util.encodeUTF8(decrypted);
                log('üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + decryptedMessage);

                if (decryptedMessage === message) {
                    log('‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                }
            } else {
                log('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏');
            }
        }

        // –¢–µ—Å—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
        function testWrongKey() {
            log('üö´ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º...');

            const alice = nacl.box.keyPair();
            const bob = nacl.box.keyPair();
            const eve = nacl.box.keyPair(); // –ï–≤–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥—Å–ª—É—à–∞—Ç—å

            const message = '–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';

            // –ê–ª–∏—Å–∞ —à–∏—Ñ—Ä—É–µ—Ç –¥–ª—è –ë–æ–±–∞
            const ephemeralKeyPair = nacl.box.keyPair();
            const nonce = nacl.randomBytes(24);

            const encrypted = nacl.box(
                nacl.util.decodeUTF8(message),
                nonce,
                bob.publicKey,
                ephemeralKeyPair.secretKey
            );

            // –ï–≤–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
            const decrypted = nacl.box.open(encrypted, nonce, ephemeralKeyPair.publicKey, eve.secretKey);

            if (!decrypted) {
                log('‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ï–≤–∞ –Ω–µ —Å–º–æ–≥–ª–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            } else {
                log('‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ï–≤–∞ —Å–º–æ–≥–ª–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        function runAllTests() {
            log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...');
            log('');

            testKeyGeneration();
            log('');

            testEncryptionDecryption();
            log('');

            testWrongKey();
            log('');

            log('üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
